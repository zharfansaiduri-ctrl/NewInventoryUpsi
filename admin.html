<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Portal - Sistem Permohonan</title>

<link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
 --bg1:#1A2350;
 --bg2:#1FA2FF;
 --card:#F4F6F8;
 --accent:#12D8FA;
 --muted:#6B7280;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'League Spartan',sans-serif;}
body{background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;padding:20px;}
.container{max-width:1400px;margin:auto;}

.header{
 background:var(--card);
 padding:30px;
 border-radius:20px;
 margin-bottom:30px;
 box-shadow:0 10px 30px rgba(0,0,0,0.2);
 position:relative;
}
.header h1{color:var(--bg1);}
.subtitle{color:#555;}
.logout{
 position:absolute;top:30px;right:30px;
 background:#ef4444;color:#fff;border:none;
 padding:12px 20px;border-radius:10px;
 cursor:pointer;font-weight:600;
}

.tabs{display:flex;gap:10px;margin-bottom:25px;}
.tab{
 flex:1;padding:15px;border-radius:12px;
 background:rgba(255,255,255,.2);
 color:white;font-weight:600;
 text-align:center;cursor:pointer;
}
.tab.active{background:var(--card);color:var(--bg1);}

.content{display:none;}
.content.active{display:block;}

.qr-grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
 gap:20px;
}
.qr-card{
 background:var(--card);
 padding:25px;
 border-radius:20px;
 text-align:center;
 box-shadow:0 10px 25px rgba(0,0,0,.2);
}
.qr-card h3{color:var(--bg1);}
.qr-box{
 background:white;
 padding:15px;
 border-radius:12px;
 margin:15px auto;
 display:flex;
 justify-content:center;
}
.btn{
 width:100%;
 padding:12px;
 background:linear-gradient(135deg,var(--bg2),var(--accent));
 color:white;border:none;
 border-radius:10px;
 font-weight:600;
 cursor:pointer;
}

/* data + dashboard */
.filter{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;}
select,input{padding:10px;border-radius:8px;border:1px solid #ccc;flex:1;min-width:150px;}
.table-wrap{background:var(--card);border-radius:12px;overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:10px;border-bottom:1px solid #ddd;}
th{background:var(--bg1);color:white;}
.loading{text-align:center;color:var(--muted);padding:20px;}
.dashboard{display:flex;gap:15px;flex-wrap:wrap;}
.card{background:var(--card);padding:20px;border-radius:12px;flex:1;min-width:180px;text-align:center;}
.card h2{color:var(--bg1);}

/* Item list styling */
.item-list{
 font-size:13px;
 max-width:300px;
}
.item-badge{
 display:inline-block;
 background:#e0f2fe;
 color:#0369a1;
 padding:3px 8px;
 margin:2px;
 border-radius:4px;
 font-size:12px;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
 <h1>Admin Portal Sistem Permohonan</h1>
 <p class="subtitle">UPSI Holdings Sdn. Bhd.</p>
 <button class="logout" onclick="logout()">Log Keluar</button>
</div>

<div class="tabs">
 <div class="tab active" onclick="tab('qr')">QR Borang</div>
 <div class="tab" onclick="tab('data')">Data Permohonan</div>
 <div class="tab" onclick="tab('dash')">Dashboard</div>
</div>

<!-- QR -->
<div id="qr" class="content active">
 <div class="qr-grid" id="qrGrid"></div>
</div>

<!-- DATA -->
<div id="data" class="content">
 <div class="filter">
  <select id="fJenis" onchange="filterData()">
   <option value="all">Semua Jenis</option>
   <option>AlatTulis2026</option>
   <option>Kenderaan2026</option>
   <option>Projektor2026</option>
  </select>
  <select id="fBulan" onchange="filterData()">
   <option value="all">Semua Bulan</option>
   <option value="01">Januari</option>
   <option value="02">Februari</option>
   <option value="03">Mac</option>
   <option value="04">April</option>
   <option value="05">Mei</option>
   <option value="06">Jun</option>
   <option value="07">Julai</option>
   <option value="08">Ogos</option>
   <option value="09">September</option>
   <option value="10">Oktober</option>
   <option value="11">November</option>
   <option value="12">Disember</option>
  </select>
  <input id="search" placeholder="Cari nama / jabatan / item" oninput="filterData()">
 </div>
 <div style="margin-bottom:15px;">
  <button class="btn" onclick="exportExcel()">Export Excel</button>
 </div>
 <div class="table-wrap">
  <table>
   <thead>
    <tr><th>No</th><th>Jenis</th><th>Nama</th><th>Jabatan</th><th>Item Diminta</th><th>Tarikh</th></tr>
   </thead>
   <tbody id="tableData">
    <tr><td colspan="6" class="loading">Memuatkan...</td></tr>
   </tbody>
  </table>
 </div>
</div>

<!-- DASHBOARD -->
<div id="dash" class="content">
 <div class="dashboard">
  <div class="card"><h2>Total</h2><p id="total">0</p></div>
  <div class="card"><h2>Alat Tulis</h2><p id="alat">0</p></div>
  <div class="card"><h2>Kenderaan</h2><p id="ken">0</p></div>
  <div class="card"><h2>Projektor</h2><p id="pro">0</p></div>
 </div>
</div>

</div>

<script>
// SECURITY
if(sessionStorage.getItem('isLoggedIn')!=='true')location.href='adminlogin.html';
function logout(){sessionStorage.clear();location.href='adminlogin.html';}

const FORM_URLS=[
 {label:"AlatTulis2026",url:"https://ict-upsiholdings.github.io/assetinventorysystem/index.html?jenis=AlatTulis2026"},
 {label:"Kenderaan2026",url:"https://ict-upsiholdings.github.io/assetinventorysystem/index.html?jenis=Kenderaan2026"},
 {label:"Projektor2026",url:"https://ict-upsiholdings.github.io/assetinventorysystem/index.html?jenis=Projektor2026"}
];

const SCRIPT_URLS=[
 {label:"AlatTulis2026",url:"https://script.google.com/macros/s/AKfycbyXUmQO6701Tv7f7vl7xuFcVgdvw0vKUSUiCjNiTx_blv2XPaYL1dPenP09ulcwc6Ug6w/exec"},
 {label:"Kenderaan2026",url:"https://script.google.com/macros/s/AKfycby0eimKxmekifIZFVHw4HnQCaIVmpXQiYJ27usQpNv7v1kCVanOyqo1X-d-N4msUKnq/exec"},
 {label:"Projektor2026",url:"https://script.google.com/macros/s/AKfycbwp9cqsZMSqcRrB04SQLWtkR0ryjATCw113ES2cogQ3A1jlD8XOLyJ0hQ1hNJCmTknf/exec"}
];

// TAB
function tab(x){
 document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
 document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
 document.querySelector(`[onclick="tab('${x}')"]`).classList.add('active');
 document.getElementById(x).classList.add('active');
 if(x==='qr')generateQR();
 if(x==='data')loadData();
 if(x==='dash')updateDash();
}

/* ======================
   QR
====================== */
function generateQR(){
 qrGrid.innerHTML = '';

 FORM_URLS.forEach((f,i)=>{
  const card=document.createElement('div');
  card.className='qr-card';

  card.innerHTML=`
   <h3>QR ${f.label}</h3>
   <div class="qr-box"><div id="qr_${i}"></div></div>
   <button class="btn" onclick="downloadQR('qr_${i}','QR_${f.label}')">
    Muat Turun
   </button>
  `;
  qrGrid.appendChild(card);

  // delay render
  setTimeout(()=>{
   new QRCode(document.getElementById(`qr_${i}`),{
    text:f.url,width:200,height:200
   });
  },100);
 });
}

function downloadQR(id,name){
 const c=document.querySelector(`#${id} canvas`);
 const a=document.createElement('a');
 a.href=c.toDataURL();a.download=name+'.png';a.click();
}

/* ===== DATA & DASHBOARD ===== */
let all=[],filtered=[];

// ✅ Convert timestamp sheet sahaja, ikut masa sheet
function formatDateTime(iso){
 if(!iso) return '-';
 const d = new Date(iso);
 const day = String(d.getDate()).padStart(2,'0');
 const month = String(d.getMonth()+1).padStart(2,'0');
 const year = d.getFullYear();
 const hours = String(d.getHours()).padStart(2,'0');
 const minutes = String(d.getMinutes()).padStart(2,'0');
 const seconds = String(d.getSeconds()).padStart(2,'0');
 return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}

// ✅ Function untuk extract item yang diminta
function extractItems(data){
 const items = [];
 
 // Check untuk field yang mungkin ada dalam form
 // Adjust field names ni based on actual Google Sheet columns
 const possibleFields = [
  'Item', 'ItemDiminta', 'Perkara', 'Barang', 
  'JenisBarang', 'NamaBarang', 'NamaItem',
  'Pen', 'Pensil', 'Kertas', 'Buku', // Alat Tulis
  'JenisKenderaan', 'ModelKenderaan', // Kenderaan
  'ModelProjektor', 'JenisProjektor' // Projektor
 ];
 
 // Loop through all possible fields
 for(const field of possibleFields){
  if(data[field] && data[field] !== '' && data[field] !== '-'){
   items.push(data[field]);
  }
 }
 
 // Jika tiada item found, try to get all non-standard fields
 if(items.length === 0){
  const standardFields = ['Timestamp', 'Nama', 'Jabatan', 'JenisPermohonan', 'Email', 'NoTelefon'];
  for(const key in data){
   if(!standardFields.includes(key) && data[key] && data[key] !== '' && data[key] !== '-'){
    items.push(`${key}: ${data[key]}`);
   }
  }
 }
 
 return items.length > 0 ? items.join(', ') : '-';
}

async function loadData(){
 all=[];tableData.innerHTML='<tr><td colspan="6" class="loading">Loading...</td></tr>';
 for(const s of SCRIPT_URLS){
  const r=await fetch(s.url);const d=await r.json();
  const rows=Array.isArray(d)?d:Object.values(d).flat();
  rows.forEach(x=>x.JenisPermohonan=s.label);
  all=all.concat(rows);
 }
 filterData();
}

function filterData(){
 const j=fJenis.value;
 const b=fBulan.value;
 const q=search.value.toLowerCase();
 filtered=all.filter(d=>{
  const bulanData = d.Timestamp ? String(new Date(d.Timestamp).getMonth()+1).padStart(2,'0') : '';
  const items = extractItems(d).toLowerCase();
  return (j==='all'||d.JenisPermohonan===j) &&
   (b==='all'||bulanData===b) &&
   ((d.Nama||'').toLowerCase().includes(q)||
    (d.Jabatan||'').toLowerCase().includes(q)||
    items.includes(q));
 });
 render();updateDash();
}

function render(){
 if(!filtered.length){
  tableData.innerHTML='<tr><td colspan="6" class="loading">Tiada Data</td></tr>';return;
 }
 tableData.innerHTML=filtered.map((d,i)=>`
 <tr>
  <td>${i+1}</td>
  <td>${d.JenisPermohonan}</td>
  <td>${d.Nama||'-'}</td>
  <td>${d.Jabatan||'-'}</td>
  <td class="item-list">${extractItems(d)}</td>
  <td>${formatDateTime(d.Timestamp)}</td>
 </tr>`).join('');
}

function exportExcel(){
 if(!filtered.length)return alert('Tiada data');
 const ws=XLSX.utils.json_to_sheet(filtered.map(d=>{
     return {
      JenisPermohonan: d.JenisPermohonan,
      Nama: d.Nama || '-',
      Jabatan: d.Jabatan || '-',
      ItemDiminta: extractItems(d),
      Timestamp: formatDateTime(d.Timestamp)
     };
 }));
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,'Permohonan');
 XLSX.writeFile(wb,'Permohonan.xlsx');
}

function updateDash(){
 total.innerText=filtered.length;
 alat.innerText=filtered.filter(x=>x.JenisPermohonan==='AlatTulis2026').length;
 ken.innerText=filtered.filter(x=>x.JenisPermohonan==='Kenderaan2026').length;
 pro.innerText=filtered.filter(x=>x.JenisPermohonan==='Projektor2026').length;
}

document.addEventListener('DOMContentLoaded',generateQR);
</script>

</body>
</html>
