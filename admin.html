<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Portal - Permohonan</title>
<link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg1:#1A2350;
  --bg2:#1FA2FF;
  --card:#F4F6F8;
  --accent:#12D8FA;
  --muted:#6B7280;
}
body{
  margin:0;
  font-family:'League Spartan',sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  min-height:100vh;
  padding:20px;
}
h1,h2,h3{color:#1A2350;text-align:center;margin-bottom:15px;}
.container{max-width:1200px;margin:auto;}
.qr-grid{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;margin-bottom:30px;}
.qr-card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.2);text-align:center;width:220px;}
.download-btn{margin-top:10px;padding:5px 10px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;font-size:12px;}
.filter{margin-bottom:10px;text-align:left;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.filter input, .filter select{padding:6px;border-radius:6px;border:1px solid #ccc;}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
thead{background:var(--bg1);color:#fff;}
th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd;}
.pdf-btn{padding:5px 10px;border:none;border-radius:6px;background:#FF5722;color:#fff;cursor:pointer;font-size:12px;margin-left:auto;}
</style>
</head>
<body>
<div class="container">
  <h1>Admin Portal - Permohonan Aset</h1>

  <!-- Bahagian QR Code -->
  <h2>QR Code Permohonan</h2>
  <div class="qr-grid" id="qrGrid"></div>

  <!-- Bahagian Senarai Permohonan -->
  <h2>Senarai Permohonan</h2>
  <div class="filter">
    <input type="text" id="searchInput" placeholder="Cari nama/jabatan...">
    <select id="bulanFilter">
      <option value="">Semua Bulan</option>
      <option value="Januari">Januari</option>
      <option value="Februari">Februari</option>
      <option value="Mac">Mac</option>
      <option value="April">April</option>
      <!-- Tambah ikut sheet anda -->
    </select>
    <select id="jenisFilter">
      <option value="">Semua Jenis</option>
      <option value="Kenderaan">Kenderaan</option>
      <option value="Alat Tulis">Alat Tulis</option>
      <option value="Projektor">Projektor</option>
      <option value="Kertas A4">Kertas A4</option>
    </select>
    <button class="pdf-btn" id="downloadPDF">Muat Turun PDF</button>
  </div>

  <table id="permohonanTable">
    <thead>
      <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
const qrUrls = [
  {url:"https://script.google.com/macros/s/AKfycbwnujNL7Zvaryk71udEAIjHYYrHym-zXLgI8p-HB1TH4zFdmf_czTIcWazRj_vZ1vhrig/exec", label:"Kenderaan"},
  {url:"https://script.google.com/macros/s/AKfycbzteaAicSGci8gjiy6qZq8PslluWWRfZNOhu7dC_8gnrU8RHuseFglRKVfFygpzk1Eu/exec", label:"Alat Tulis"},
  {url:"https://script.google.com/macros/s/AKfycbywBA3URsRomdjq2lH_zLKn0PYivCOVn6AgFWINVPQfScYXUq2SlMoOvmi-WhfcRbjP/exec", label:"Projektor"},
  {url:"https://script.google.com/macros/s/AKfycbwoDHhFJuucCtB-Lt0VJLWQ7sq_U7UmXoRip_hD_WFqFT0Z6ml7vbuyFExw3f8ByTkZ/exec", label:"Kertas A4"}
];

function generateQRCodes(){
  const grid = document.getElementById('qrGrid');
  grid.innerHTML='';
  qrUrls.forEach((item,index)=>{
    const card=document.createElement('div');
    card.className='qr-card';
    card.innerHTML=`<h3>${item.label}</h3><div id="qr${index+1}"></div>
    <button class="download-btn" onclick="downloadQR('qr${index+1}','QR_${item.label.replace(/\s/g,'_')}')">Muat Turun</button>`;
    grid.appendChild(card);
    new QRCode(document.getElementById(`qr${index+1}`),{
      text:item.url,
      width:200,
      height:200,
      colorDark:"#1A2350",
      colorLight:"#fff",
      correctLevel:QRCode.CorrectLevel.H
    });
  });
}

function downloadQR(id,filename){
  const qrCanvas = document.getElementById(id).querySelector('canvas');
  const link = document.createElement('a');
  link.href = qrCanvas.toDataURL("image/png");
  link.download = filename+'.png';
  link.click();
}

let currentData = [];
async function fetchData(){
  try{
    const urls=[
      "https://script.google.com/macros/s/AKfycbwnujNL7Zvaryk71udEAIjHYYrHym-zXLgI8p-HB1TH4zFdmf_czTIcWazRj_vZ1vhrig/exec?sheet=Permohonan",
      "https://script.google.com/macros/s/AKfycbzteaAicSGci8gjiy6qZq8PslluWWRfZNOhu7dC_8gnrU8RHuseFglRKVfFygpzk1Eu/exec?sheet=Permohonan",
      "https://script.google.com/macros/s/AKfycbywBA3URsRomdjq2lH_zLKn0PYivCOVn6AgFWINVPQfScYXUq2SlMoOvmi-WhfcRbjP/exec?sheet=Permohonan",
      "https://script.google.com/macros/s/AKfycbwoDHhFJuucCtB-Lt0VJLWQ7sq_U7UmXoRip_hD_WFqFT0Z6ml7vbuyFExw3f8ByTkZ/exec?sheet=Permohonan"
    ];
    currentData=[];
    for(const u of urls){
      const res=await fetch(u);
      const d=await res.json();
      currentData.push(...d);
    }
    displayTable(currentData);
  }catch(err){console.error(err);}
}

function displayTable(data){
  const tableHeader=document.getElementById('tableHeader');
  const tableBody=document.getElementById('tableBody');
  tableHeader.innerHTML=''; tableBody.innerHTML='';
  if(data.length===0) return;
  Object.keys(data[0]).forEach(h=>{
    const th=document.createElement('th'); th.textContent=h; tableHeader.appendChild(th);
  });
  data.forEach(row=>{
    const tr=document.createElement('tr');
    Object.values(row).forEach(val=>{
      const td=document.createElement('td'); td.textContent=val; tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });

  // Filter events
  const searchInput=document.getElementById('searchInput');
  const jenisFilter=document.getElementById('jenisFilter');
  const bulanFilter=document.getElementById('bulanFilter');

  function applyFilter(){
    const searchVal=searchInput.value.toLowerCase();
    const jenisVal=jenisFilter.value;
    const bulanVal=bulanFilter.value;
    Array.from(tableBody.querySelectorAll('tr')).forEach(tr=>{
      const tds=tr.querySelectorAll('td');
      const namaJabatan=(tds[1].textContent + " " + tds[2].textContent).toLowerCase(); // sesuaikan index
      const jenis=tds[0].textContent;
      const bulan=tds[3]?.textContent || ""; // index bulan
      if((!searchVal || namaJabatan.includes(searchVal)) &&
         (!jenisVal || jenis===jenisVal) &&
         (!bulanVal || bulan===bulanVal)){
        tr.style.display='';
      }else{tr.style.display='none';}
    });
  }

  searchInput.addEventListener('input',applyFilter);
  jenisFilter.addEventListener('change',applyFilter);
  bulanFilter.addEventListener('change',applyFilter);
}

// Muat Turun PDF
document.getElementById('downloadPDF').addEventListener('click',()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;
  const filterValue = document.getElementById('jenisFilter').value;
  const searchVal = document.getElementById('searchInput').value.toLowerCase();
  const bulanVal = document.getElementById('bulanFilter').value;
  const filtered = currentData.filter(r=>{
    const namaJabatan=(r["Nama"]+" "+r["Jabatan"]).toLowerCase();
    const jenis=r["Jenis Permohonan"];
    const bulan=r["Bulan"];
    return (!searchVal || namaJabatan.includes(searchVal)) &&
           (!jenisFilter.value || jenis===filterValue) &&
           (!bulanVal || bulan===bulanVal);
  });
  if(filtered.length===0){alert("Tiada data untuk dijana PDF"); return;}
  const headers = Object.keys(filtered[0]);
  doc.setFontSize(14); doc.text("Laporan Permohonan",105,y,{align:"center"}); y+=10;
  doc.setFontSize(10);
  headers.forEach((h,i)=>doc.text(h,10+i*40,y));
  y+=7;
  filtered.forEach(row=>{
    Object.values(row).forEach((val,i)=>doc.text(val.toString(),10+i*40,y));
    y+=7; if(y>280){doc.addPage(); y=10;}
  });
  doc.save('Laporan_Permohonan.pdf');
});

generateQRCodes();
fetchData();
</script>
</body>
</html>
